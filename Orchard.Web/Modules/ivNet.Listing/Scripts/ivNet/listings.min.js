var ListingsGrid = angular.module('ivNet.Listings', ['ngResource', 'trNgGrid']);

ListingsGrid.factory('ownerListings', function ($resource) {
    return $resource('/api/listing/listing/:id', null,
    {
        'query': { method: 'GET', isArray: true },
    });
});

ListingsGrid.factory('listingCategories', function ($resource) {
    return $resource('/api/listing/category/:id', null,
    {
        'query': { method: 'GET', isArray: true },
    });
});

ListingsGrid.factory('listingPackages', function ($resource) {
    return $resource('/api/listing/package/:id', null,
    {
        'query': { method: 'GET', isArray: true },
    });
});

ListingsGrid.controller('ListingsGridController', function ($scope,
    ownerListings,
    listingCategories,
    listingPackages) {

    init();

    $scope.addListing = function() {

        $('section#listingEdit').hide("blind", { direction: "up" }, 500, function() {
            $('section#listingTable').hide();
            $('section#listingEdit').show();
        });
    };

    $scope.addTheatre = function () {
        if ($scope.theatreName.length > 0) {
            $scope.theatreList.push({
                Id: ($scope.theatreList.length + 1), Name: $scope.theatreName, Town: $scope.theatreTown, Distance: $scope.theatreDistance, Transport: $scope.transport });
        }
    };

    $scope.addRoom = function () {
        if ($scope.roomType !== undefined) {
            $scope.roomList.push({
                Id: ($scope.roomList.length + 1), RoomType: $scope.roomType, Description: $scope.roomDescription
            });
        }
    };

    $scope.addTag = function () {
        if ($scope.tag.length > 0) {
            $('input#tagList').tagsinput('add', $scope.tag);
        }
    };

    $scope.removeTheatre = function() {
        $.each($scope.theatreSelectedItems, function (selectionIndex, selectionItem) {
            var theatreItemIndex = -1;
            $.each($scope.theatreList, function (theatreIndex, theatreItem) {
                if (theatreIndex == selectionItem.Id - 1) {
                    theatreItemIndex = theatreIndex;
                }
            });

            $scope.theatreList.splice(theatreItemIndex, 1);
        });
    };

    $scope.removeRoom = function () {
        $.each($scope.roomSelectedItems, function (selectionIndex, selectionItem) {
            var roomItemIndex = -1;
            $.each($scope.roomList, function (roomIndex, roomItem) {
                if (roomIndex == selectionItem.Id - 1) {
                    roomItemIndex = roomIndex;
                }
            });

            $scope.roomList.splice(roomItemIndex, 1);
        });
    };

    $scope.saveListing = function () {

        var $form = $("form");
        var validator = $form.data("validator");

        if (!validator || !$form.valid()) {
            e.preventDefault();
            return;
        }

        //$('section#listingTable').hide("blind", { direction: "up" }, 500, function () {
        //    $('section#listingEdit').hide();
        //    $('section#listingTable').show();
        //});
    };

    function init() {

        $('section#listingEdit').hide();

        ownerListings.query({},
            function(data) {
                $scope.listings = data;
            },
            function(error) {
                alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
            });

        listingCategories.query({},
            function(data) {
                $scope.categories = data;
            },
            function(error) {
                alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
            });

        listingPackages.query({},
          function (data) {
              $scope.packages = data;
          },
          function (error) {
              alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
          });

        $('#fileupload').fileupload({
            dataType: 'json',
            url: '/owner/uploadfiles',
            autoUpload: true,
            done: function (e, data) {
               
                if (data.result.size.length > 0) {
                    $scope.fileList.push({
                        Id: ($scope.fileList.length + 1), File: data.result.name, Size: data.result.size
                    });
                }

                $scope.$apply();

                // $('.file_name').html(data.result.name);
                //$('.file_type').html(data.result.type);
                // $('.file_size').html(data.result.size);
            }
        });

        $scope.transportList = [{ Id: 1, Name: "Car" }, { Id: 2, Name: "Walking" }, { Id: 3, Name: "Bus" }];
        $scope.roomTypeList = [{ Id: 1, Type: "Single" }, { Id: 2, Type: "Double" }, { Id: 3, Type: "Twin" }, { Id: 4, Type: "Other" }];
        $scope.tagList = [{ Id: 1, Name: "Bathroom - Shared" }, { Id: 2, Name: "Bathroom - Ensuite" }, { Id: 3, Name: "Breakfast - Included" }, { Id: 4, Name: "Breakfast - Not Included" }];

        $scope.theatreList = [];
        $scope.roomList = [];
        $scope.fileList = [];

        $scope.theatreSelectedItems = [];
        $scope.roomSelectedItems = [];
        $scope.fileSelectedItems = [];
    }

});


$(document).ready(function () {
   
    //    .on('fileuploadprogressall', function (e, data) {
    //    var progress = parseInt(data.loaded / data.total * 100, 10);
    //    $('.progress .progress-bar').css('width', progress + '%');
    //});
});